#make vunerability indicators

# hh_data<-HH_severity
# population

# for_bronwyn<-data.frame(HH_severity$X_uuid, FCS=HH_severity$I.FCS_score, HHDDS_over5=HH_severity$HDDS_over5,improved_drinking_water=HH_severity$int.wash.improved_water_drinking)
# write.csv(for_bronwyn, paste0("20191201_",population, ".csv"))
# population
# debugonce(make_2019_msna_vulnerability_composites)
# individual_data<-Indiv_with_composite

           
make_2019_msna_vulnerability_composites<-function(hh_data,individual_data,new_indicators){
  colnames(new_indicators)<-colnames(new_indicators) %>% gsub(" ", "_",.)
  new_indicators[,1:ncol(new_indicators)]<-new_indicators[,1:ncol(new_indicators)] %>% purrr::map(trimws)
  new_indicators_both_pops<-new_indicators %>% filter(population_group =="both")
  new_indicators_refugee<-new_indicators %>% filter(population_group== "refugee only")
  new_indicators_hc<-new_indicators %>% filter(population_group=="HC only")
  
  ind_to_hh<-individual_data %>% 
    mutate(adult_male_yn=ind_gender=="male" & ind_age %in% c(18:59),1,0) %>% 
    group_by(X_submission__uuid) %>% 
    summarise(!!new_indicators_both_pops$new_indicator_name[3]:=ifelse(sum(adult_male_yn, na.rm=TRUE)==0,1,0))
  
  hh_data<-hh_data %>% 
    mutate(!!new_indicators_both_pops$new_indicator_name[1]:= market_problems.none==FALSE & market_problems.dont_know==FALSE,
           !!new_indicators_both_pops$new_indicator_name[2]:= int.sev_score.protection.sub.services.gbv%in% c(5,6)==FALSE ,
           !!new_indicators_both_pops$new_indicator_name[4]:= hh_coping_mechanism.borrowed|hh_coping_mechanism.bought_on_credit
           # !!new_indicators_both_pops$new_indicator_name[5]:=hh_coping_mechanism.sell_food|
           # hh_coping_mechanism.sell_assist|hh_coping_mechanism.sell_hhgoods)
    )
  if(population=="Refugee"){

  hh_data<-hh_data %>% 
    mutate(
      !!new_indicators_refugee$new_indicator_name[1]:= distribution_challenges.none==FALSE,
      !!new_indicators_refugee$new_indicator_name[2]:=aidworkers_barriers.none==FALSE,
      !!new_indicators_refugee$new_indicator_name[3]:=hh_coping_mechanism.sell_food|hh_coping_mechanism.sell_assist|hh_coping_mechanism.sell_hhgoods
    )
  
  ind_to_hh<-individual_data %>% 
    mutate(ind.treatment_location=ifelse((treatment_location.govt_clinic| treatment_location.ngo_clinic)&
                                           (treatment_location.private_clinic==FALSE & treatment_location.pharmacy==FALSE),1,0)) %>% 
    group_by(X_submission__uuid) %>% 
    summarise(!!new_indicators_refugee$new_indicator_name[4]:=sum(ind.treatment_location, na.rm=TRUE)) %>% left_join(ind_to_hh)
  }
  if(population=="Host"){
    hh_data<-hh_data %>% 
      mutate(
         !!new_indicators_hc$new_indicator_name[1]:= ifelse(edu_highest %in%
                                                            c(as.character(c(0:5)),"none","madrasah_only"),"primary_less",
                                                          ifelse(edu_highest %in% as.character(c(6:11)),"some_secondary", "secondary_more")),
         !!new_indicators_hc$new_indicator_name[2]:=education_barrier.help_family|education_barrier.child_income
        
      )
  }
  hh_data_composite<-left_join(hh_data, ind_to_hh, by= c("X_uuid"="X_submission__uuid"))
  return(hh_data_composite)
}

theme_reach_base <- theme(text=element_text(family="Arial Narrow"),
                     plot.title=element_text(size=12),
                     panel.border=element_blank(),
                     strip.text=element_text(size=20),
                     plot.background=element_rect(fill="white",color = NA),
                     panel.background = element_rect("white"),
                     panel.grid.major.y=element_line("black"),
                     panel.grid.major.x=element_blank(),
                    
                     axis.ticks.x=element_line(),
                     axis.title=element_text(size=10),
                     axis.text.x=element_text(angle=60,hjust=1,size=11),
                     axis.text.y=element_text(size=11,margin = margin(r=5)),
                     legend.text = element_text(lineheight = .9,size = 9),
                     legend.title = element_text(size=10),
                     legend.key.height=unit(.5,"cm"),
                     legend.position="right")

