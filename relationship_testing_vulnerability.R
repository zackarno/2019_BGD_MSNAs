#relationship testing


# Choose files ------------------------------------------------------------

rm(list=ls())
user<-"zack"
population<-c("Host","Refugee")[2]
data_process<-c("checking", "cleaning", "analysis")[3]
analysis_phase<-c("basic","relationship_testing")[2]


# Setup -------------------------------------------------------------------


library(dplyr)
# library(GISutils)
# detach("package:butteR", unload = TRUE)
library(nngeo)
library(dplyr)
library(hypegrammaR)
library(koboquest)
library(stringr)
library(lubridate)
library(rgdal)
library(sf)
library(anytime)
library(srvyr)
library(forcats)
library(tmap)
library(gapminder)
library(plotly)
library(ggplot2)
library(effects)
tmap_mode("view")

source("Functions/colours.R")
source("Functions/ActivatePaths.R")
source("Functions/make_composite_indicators_bgd_msna_2019_mk.R")
# source("Functions/make_composite_indicators_bgd_msna_2019.R")
source("Functions/calculate_shelter_topology.R")
source("Functions/general_utils.R")
source("Functions/recode_to_severity_bgd_msna2019.R")
source("Functions/recoding_severity/recode_SNFI_severity_bgd2019.R")
source("Functions/recoding_severity/recode_HEALTH_severity_bgd2019.R")
source("Functions/recoding_severity/recode_COPING_severity_bgd2019.R")
source("Functions/recoding_severity/recode_EDUCATION_severity_bgd2019.R")
source("Functions/recoding_severity/recode_WASH_severity_bgd2019.R")
source( "Functions/recoding_severity/recode_PROTECTION_severity_bgd2019.R")
source( "Functions/recoding_severity/recode_FOODSECURITY_severity_bgd2019.R")
source("Functions/recoding_severity/calculate_INTERSECTORAL_severity_bgd2019.R")

#LOAD DATA

HH_kobo_questions<-read.csv(survey_path,stringsAsFactors = FALSE)
HH_kobo_choices<-read.csv(choices_path, stringsAsFactors = FALSE)
wash_combo_table<-read.csv(wash_severity_combination_path, stringsAsFactors = FALSE, na.strings=c("", " ", NA, "NA"))
wash_errors<- read.csv(wash_error_path,na.strings = c("", " "))



incidents_per_camp<-read.csv("Inputs/DAPs/Severity Analysis_Protection_Reported Incidents per camp_REACH.csv", stringsAsFactors = FALSE, na.strings=c("", " ", NA, "NA"))



if (population=="Refugee"){
  HH_with_env<-read.csv(HH_path, stringsAsFactors = FALSE, na.strings=c("", " ", NA, "NA"))
  analysis_phase<-c("basic","relationship_testing")[1]
  source("Functions/ActivatePaths.R")
  HH_clean_final<-read.csv(HH_path, stringsAsFactors = FALSE, na.strings=c("", " ", NA, "NA"))
  HH<-HH_clean_final %>% left_join(HH_with_env%>% select("X_uuid","euc_dist_to_camp_m", "dem_30m", "pop_dens_sqkm_per_grid_50_m", 
                                                         "pop_dens_sqkm_per_grid_100_m", "pop_dens_sqkm_per_grid_200_m", 
                                                         "shelters_per_grid_50_m", "shelters_per_grid_100_m", "shelters_per_grid_200_m"
  ), by= "X_uuid")
}

if (population=="Host"){
  HH<-read.csv(HH_path, stringsAsFactors = FALSE, na.strings=c("", " ", NA, "NA"))}


Indiv<-read.csv(Indiv_path, stringsAsFactors = FALSE, na.strings=c("", " ", NA, "NA"))
HH_kobo_questionnaire<-koboquest::load_questionnaire(HH,questions = HH_kobo_questions,choices = HH_kobo_choices, choices.label.column.to.use = "label..english")
pop<- read.csv(pop_path, stringsAsFactors = FALSE, na.strings=c("", " ", NA))

#only yes consent
HH_yes_consent<- HH %>% filter(informed_consent=="yes")
indiv_yes_consent<-Indiv %>% filter(X_submission__uuid %in% HH_yes_consent$X_uuid)
# debugonce(make_composite_indicators_bgd_msna_2019)


enough_water_cols_to_fix<-HH_yes_consent %>% select(starts_with("enough_water")) %>% colnames()
rows_to_fix<-which(HH_yes_consent$X_uuid %in% wash_errors$uuid)
HH_yes_consent[rows_to_fix,enough_water_cols_to_fix] <-sapply(HH_yes_consent[rows_to_fix,enough_water_cols_to_fix],function(x)x<-NA) 

dap_relations<-readxl::read_xlsx(path = "Inputs/DAPs/MSNA Design - Sector Engagement.xlsx", sheet = "Analysis_Vulnerability and Rela")
new_indicators<-readxl::read_xlsx(path =  "Inputs/DAPs/MSNA Design - Sector Engagement.xlsx",sheet = "reach_new_indicators") 
new_indicators
new_indicators%>% filter(`population group` %in% c("both", "HC only"))



composite_indicators<-make_composite_indicators_bgd_msna_2019(hh_data = HH_yes_consent,  individual_data = indiv_yes_consent,population = population)
HH_with_composite<-HH_yes_consent %>% left_join(composite_indicators$household_composites,by="X_uuid")

Indiv_with_composite<-indiv_yes_consent %>% left_join(composite_indicators$individual_composites,by="X_index")
HH_with_composite<-butteR::remove_concat_select_multiple(HH_with_composite,questionnaire = HH_kobo_questionnaire)

# debugonce(recode_HEALTH_severity_bgd2019)

HH_severity<-HH_with_composite

HH_severity<- recode_COPING_severity_bgd2019(HH_severity, individual_data = Indiv_with_composite, population=population)
# debugonce(recode_WASH_severity_bgd2019)
HH_severity<- recode_WASH_severity_bgd2019(HH_severity, individual_data = Indiv_with_composite, population=population, wash_combo_table = wash_combo_table)
HH_severity<-recode_SNFI_severity_bgd2019(hh_data= HH_severity, individual_data=Indiv_with_composite, population=population)
HH_severity<-recode_HEALTH_severity_bgd2019(hh_data= HH_severity, individual_data=Indiv_with_composite, population=population)
HH_severity<-recode_EDUCATION_severity_bgd2019(hh_data= HH_severity, individual_data=Indiv_with_composite, population=population)
HH_severity<-recode_PROTECTION_severity_bgd2019(hh_data= HH_severity, individual_data=Indiv_with_composite, population=population)
HH_severity<-recode_FOODSECURITY_severity_bgd2019(hh_data= HH_severity, individual_data=Indiv_with_composite, population=population)

all_sectoral_severity_scores<-HH_severity %>% select(intersect(starts_with("sev_score"), ends_with(".total"))) %>%colnames()

HH_severity<-calculate_INTERSECTORAL_severity_bgd_msna2019(HH_severity,sectoral_scores =all_sectoral_severity_scores,coping_strategy_score = "sev_score.coping.total" )


HH_severity<-make_2019_msna_vulnerability_composites(HH_severity, new_indicators = new_indicators, individual_data = Indiv_with_composite)


# weighting ---------------------------------------------------------------




# CALCULATE WEIGHTS AND MAKE SURVEY

if(population=="Refugee"){
  HH_severity<-HH_severity %>%
    group_by(!!sym(strata)) %>%
    filter(n()>10) %>%
    ungroup()
  
  pop<-pop %>% 
    filter(!is.na(Camp)& is.na(Block)) %>% 
    mutate(
      camp_id=str_replace(Camp, "Total","") %>% trimws(),
      Total.Families=as.numeric(Total.Families)
    ) %>% 
    select(camp_id, Total.Families,Total.Individuals)
  
}else{
  pop[[sf_strata]]<-if_else(pop[[sf_strata]] =="Teknaf Sadar" , "Teknaf",pop[[sf_strata]]) 
} 




pop$camp_id %in% HH_severity$camp_name
which(HH_severity$camp_name %in% pop$camp_id ==FALSE)

weighting<-map_to_weighting(sampling.frame = pop, 
                            data.stratum.column = strata,
                            data = HH_severity, 
                            sampling.frame.population.column =sf_pop,
                            sampling.frame.stratum.column = sf_strata)



HH_svy_ob<-map_to_design(data=HH_severity, weighting_function = weighting)

Indiv_with_relevant_HH_data<-Indiv_with_composite %>% left_join(HH_svy_ob$variables %>% 
                                                                  mutate(
                                                                    weights= weights(HH_svy_ob)
                                                                    ) %>% 
                                                                  select(X_uuid,{strata},respondent_gender,weights,euc_dist_to_camp_m), by=c("X_submission__uuid"="X_uuid"))

ind_svy_ob<-survey::svydesign(ids = ~ 1,
                              strata =  formula(paste0("~",strata)),
                              weights= ~weights,
                              data = Indiv_with_relevant_HH_data)


dap_relations %>% colnames()
colnames(dap_relations)<-colnames(dap_relations) %>% gsub(" ", "_",.)
dap_relations$Indicator_of_interest
dap_relations$Population_group
DAP<-dap_relations %>% rename(ind_var="REACH-specific:_Variable_name_(independent_var)",
                         dep_var= "REACH-specific:_Variable_name_(indicator)",
                         ind_var_label="Household_/_Respondent_Characteristic",
                         filter_action="...5" ) %>% 
  mutate(
    population_group=if_else(stringr::str_starts(string=Population_group ,pattern ="ref" ),"Refugee",
                                              "Host",missing="both")
    
  ) %>% 
  filter(filter_action!="d", population_group%in%c(population,"both")) %>% 
  select(Indicator_of_interest,ind_var_label,ind_var, dep_var,population_group) %>% 
  filter(!is.na(ind_var)& !is.na(dep_var)) %>% 
  mutate(dep_leg_label=stringr::str_wrap(dep_var, width = 10),
         ind_leg_label=stringr::str_wrap(ind_var, width = 10),
         indicator_label=stringr::str_wrap(Indicator_of_interest, width=60))
DAP$ind_var_label
DAP$Indicator_of_interest

HH_srv<- srvyr::as_survey(HH_svy_ob)
plot_list<-list()
plots_2<-list()
for(i in 1: nrow(DAP)){
  ind_var_temp<-DAP$ind_var[i]
  dep_var_temp<-DAP$dep_var[i]
  indicator_temp<-DAP$Indicator_of_interest[i]
  indicator_label_temp<-DAP$indicator_label[i]
  ind_leg_label_temp<-DAP$ind_leg_label[i]
  dep_leg_label_temp<-DAP$dep_leg_label[i]
  ind_var_label<-DAP$ind_var_label[i]
  if((ind_var_temp %in% colnames(HH_srv$variables)==TRUE)& (dep_var_temp %in% colnames(HH_srv$variables)==TRUE)){
    
    HH_srv$variables[[ind_var_temp]]<-HH_srv$variables[[ind_var_temp]] %>% as.factor()
    HH_srv$variables[[dep_var_temp]]<-HH_srv$variables[[dep_var_temp]] %>% as.factor()
    
    ind_by_dep_sumstat_table<-HH_srv %>% group_by(!!sym(ind_var_temp),!!sym(dep_var_temp),.drop = FALSE) %>% 
      summarise(mean.stat=survey_mean(vartype="ci"),
                n=unweighted(n()))
    
    
    chisq_result<-srvyr::svychisq(formula = formula(paste0("~",ind_var_temp,"+",dep_var_temp)), design= HH_srv)
    chisq_pval <-round(chisq_result$p.value,3)
    chisq_pval_with_star<-ifelse(chisq_pval<0.05,paste0(chisq_pval,"*"),chisq_pval)
    plot_list[[i]]<-ggplot(ind_by_dep_sumstat_table, aes_string(x=ind_var_temp,y="mean.stat", fill=dep_var_temp))+
      scale_fill_brewer(palette='Pastel1', name=dep_leg_label_temp)+
      scale_y_continuous(labels=scales::percent)+
      geom_bar(stat="identity", position="dodge")+
      geom_errorbar(data=ind_by_dep_sumstat_table,
                    aes(ymin=mean.stat_low, 
                        ymax=mean.stat_upp),
                    position = position_dodge(width = 0.9), width = 0.1)+
      geom_text(aes(y=max(mean.stat_upp)+.05,label= n,fontface=3), position = position_dodge(width = 0.9))+
      ggtitle(paste0(indicator_label_temp," p value =",
                                           chisq_pval_with_star))+
      theme_reach_base+ theme(axis.title.y = element_blank())
    
    
    plots_2[[i]]<-ggplot(ind_by_dep_sumstat_table, aes_string(x=dep_var_temp,y="mean.stat", fill=ind_var_temp))+
      scale_fill_brewer(palette='Pastel1', name=ind_leg_label_temp)+
      scale_y_continuous(labels=scales::percent)+
      geom_bar(stat="identity", position="dodge")+
      geom_errorbar(data=ind_by_dep_sumstat_table,
                    aes(ymin=mean.stat_low, 
                        ymax=mean.stat_upp),
                    position = position_dodge(width = 0.9), width = 0.1)+
      geom_text(aes(y=max(mean.stat_upp)+.05,label= n,fontface=3), position = position_dodge(width = 0.9))+labs(x=dep_var_temp)+
      ggtitle(paste0(indicator_label_temp," p value =",
                     chisq_pval_with_star))+
      theme_reach_base+ theme(axis.title.y = element_blank())


    
    }
  if((ind_var_temp %in% colnames(HH_svy_ob$variables)==FALSE)| (dep_var_temp %in% colnames(HH_svy_ob$variables)==FALSE)){
    print(paste0(ind_var_temp, " or", dep_var_temp, " missing"))
  }
  

        
}

# ggsave(filename = "asdf.png")
p<-plot_list[[2]]
p2<-plots_2[[2]]

p
p2

ggsave('test.png', p)
ggsave(plot_list[[2]],width = 6,height = 4,units = "in","plot.png", device = png)
print(plot_list[[3]])

HH_severity[,colnames(HH_severity)[colnames(HH_severity)%in%DAP$dep_var]] %>% head()

HH_severity$I.HH_CHAR.no_adult_males
dependent_string.yesans<-paste0(dependent_string,"yes")
se_dependent_string<-paste0("se.", dependent_string)
formula_dependent<-paste0("~", dependent_string)
formula_independent<-paste0("~",independent_string)
table_formula<-(paste0(formula_independent, "+", dependent_string))
print(table_formula)
result_chisq<-svychisq(formula(table_formula),HH_svy_ob)
print("chisq stat calculated")
pval<-result_chisq$p.value
pval_label<-ifelse(pval<0.05,"<.05", ifelse(pval<.005,"<.005",">.05"))
print("pval label made")
# plot_title<-paste0(plot_titles[i]," (p",pval_label,")")
plot_title<-paste0(dependent_string," (p",pval_label,")")
svyby_table<-svyby(formula(formula_dependent), formula(formula_independent),HH_svy_ob, svymean, na.rm=T) %>% data.frame() 
print("svytable made")


dependent_string.yes<-svyby_table %>%
  select(intersect(starts_with(dependent_string),
                   ends_with("yes"))) %>% colnames()
print("asdf")
se_dependent_string.yes<-svyby_table %>% 
  select(intersect(starts_with(se_dependent_string), 
                   ends_with("yes"))) %>% colnames()

svyby_table<-svyby_table %>% 
  mutate(
    err_ymin=!!sym(dependent_string.yes)-(1.96*!!sym(se_dependent_string.yes)),
    err_ymax=!!sym(dependent_string.yes)+(1.96*!!sym(se_dependent_string.yes)),
  )
print("asdfgh")
er<-geom_errorbar(data = svyby_table,aes(ymin=err_ymin,
                                         ymax=err_ymax), color="white", size=2,width=0.2)
plot_list[[dependent_string]]<-
  ggplot(svyby_table,aes(factor(!!sym(independent_string)), !!sym(dependent_string.yes)))+
  geom_bar(stat= "identity", colour="white")+
  er+
  xlab("I.indi_dia_per_INDIVHH")+ 
  ggtitle(plot_title)+
  scale_y_continuous(labels = scales::percent)+
  theme(
    panel.grid = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_text(angle=45,size = 10),
    # text = element_text(size=10)
  )

svyby_table_list[[dependent_string]]<-svyby_table

if(result_chisq$p.value<.05){
  significant_table_list[[dependent_string]]<-svyby_table
}
if(result_chisq$p.value>=0.05){
  not_significant_table_list[[dependent_string]]<-svyby_table
}
}





HH_svy_ob$variables[[dep_var_temp]]
svyby(~I.HH_CHAR.gender_hoh.HH,~I.FSL.market_problems_any, HH_svy_ob, svymean)


HH_severity$hoh_gender
HH_severity$hoh
HH_severity$camp_name
svyby(~factor(hoh_gender)+factor(hoh_marital), ~factor(camp_name), HH_svy_ob, svymean)
svymean(~factor(hoh_gender)+factor(hoh_marital, HH_svy_ob, svymean)
svymean(~factor(hoh_gender)+factor(hoh_marital), HH_svy_ob,na.rm=TRUE))
svymean(~hoh_gender+hoh_marital, HH_svy_ob,na.rm=TRUE)
svyby(formula = ~hoh_gender+hoh_marital,by = ~camp_name, design = HH_svy_ob, FUN = svymean)
svyby(formula = ~factor(hoh_gender)+factor(hoh_marital),by = ~factor(camp_name), design = HH_svy_ob, FUN = svymean)
svyby(formula = ~hoh_gender+hoh_marital,by = ~camp_name, design = HH_svy_ob, FUN = svymean, na.rm=TRUE)
svytable(formula = ~hoh_gender+camp_name, design = HH_svy_ob)

prop.table(svytable(formula = ~hoh_gender+camp_name, design = HH_svy_ob)) %>% data.frame()
svymean(~interaction(hoh_gender,camp_name), HH_svy_ob,na.rm=TRUE)

# svyciprop(~factor(hoh_gender)+factor(hoh_marital), HH_svy_ob,na.rm=TRUE)

2wash# Distance to camp --------------------------------------------------------

HH_srvy_ob<-as_survey(HH_svy_ob)
HH_srvy_ob$variables$euc_dist_to_camp_km=HH_srvy_ob$variables$euc_dist_to_camp_m/1000


#FIREWOOD VS DISTANCE
firewood_model<-svyglm(formula = cooking_fuel.collected_firewood~ euc_dist_to_camp_km,
           HH_srvy_ob)
sjPlot::tab_model(firewood_model, auto.label = FALSE,title = "Table 1. Firewood vs Distance")# proxmity to camp
plot(allEffects(firewood_model))

#TENSIONS BETWEEN COMMUNITY AND ROHINGYA
HH_srvy_ob$variables$tension<-HH_srvy_ob$variables$tension %>% as.factor()
HH_srvy_ob$variables$tension_binary<-ifelse(HH_srvy_ob$variables$tension=="yes",1,0)
question_lable<-HH_kobo_questionnaire$question_get_question_label("tension")
question_label<-HH_kobo_questionnaire$question_get_question_label("tension")
tension_between_rohingya_host_model<-svyglm(formula = tension_binary~ euc_dist_to_camp_km,HH_srvy_ob)
plot(allEffects(tension_between_rohingya_host_model), main=question_label)
sjPlot::tab_model(tension_between_rohingya_host_model,
                  auto.label = FALSE,
                  title = paste0("Table 2. ",
                                 question_label))# 

#distance and humanitarian aid
question_label<-HH_kobo_questionnaire$question_get_question_label("humanitarian_aid")
HH_srvy_ob$variables$humanitarian_aid_yes_binary<-if_else(HH_srvy_ob$variables$humanitarian_aid=="yes",1,0)

humanitarian_aid_distance_model<-svyglm(formula = humanitarian_aid_yes_binary~ euc_dist_to_camp_km,HH_srvy_ob)
plot(allEffects(humanitarian_aid_distance_model), main=question_label)
sjPlot::tab_model(humanitarian_aid_distance_model,
                  auto.label = FALSE,
                  title = paste0("Table 3. ",
                                 question_label))
plot(allEffects(humanitarian_aid_distance_model), main=question_label)

#WASH AGAINST DISTANCE
question_label<- "Enough Water For All WASH Needs"
HH_srvy_ob$variables$enough_water_all_needs<-if_else(HH_srvy_ob$variables$I.WASH.enough_water_all_needs.HH=="yes",1,0)

wash_all_water_needs_distance<-svyglm(formula = enough_water_all_needs~ euc_dist_to_camp_km,HH_srvy_ob)
wash_all_water_needs_distance_union<-svyglm(formula = enough_water_all_needs~ euc_dist_to_camp_km+union_name,HH_srvy_ob)

# HH_srvy_ob$variables$union_name
plot(allEffects(wash_all_water_needs_distance), main= question_label, xlab="Distance to camp (km)")


sjPlot::tab_model(wash_all_water_needs_distance, auto.label = FALSE,title = paste0 ("Table 4. ", question_label))
sjPlot::tab_model(wash_all_water_needs_distance_union, auto.label = FALSE,title = paste0 ("Table 4. ", question_label))

#dry season- surface water use
HH_kobo_questionnaire$question_get_question_label("surface_water_access")

question_label<- "Use of Surface Water in Dry Season"
HH_srvy_ob$variables$used_surface_water_in_dry_season<-if_else(HH_svy_ob$variables$surface_water_access %in% c("dont_know", "never"),0,1)
surface_water_use_distance_model<-svyglm(formula = used_surface_water_in_dry_season~ euc_dist_to_camp_km,HH_srvy_ob)

plot(allEffects(surface_water_use_distance_model), main= question_label)
sjPlot::tab_model(surface_water_use_distance_model, auto.label = FALSE,title = "Table 1. dist camp")# proxmity to camp


#DISTANCE AGAINST SEVERITY?
intersectoral_severity_distance_model<-svyglm(formula = intersectoral_severity.total~ euc_dist_to_camp_km,HH_srvy_ob)
summary(intersectoral_severity_distance_model)
plot(allEffects(intersectoral_severity_distance_model), main= question_label)

#loop through each of the sectors

sectoral_totals<-c("sev_score.wash.total", "sev_score.snfi.total", 
                   "sev_score.health.total", "sev_score.education.total", "sev_score.protection.total",
                   "sev_score.FS.total")

sectoral_distance_logistic_graphs<-list()
pval<-list()

for ( i in 1: length(sectoral_totals)){
  sector_of_interest<-sectoral_totals[i]
  model_of_interest<-svyglm(formula = formula(paste0(sector_of_interest, "~euc_dist_to_camp_km + Upazila")),HH_srvy_ob)
  pval_df=data.frame(coef(summary(model_of_interest)))
  pval[[sector_of_interest]]= round(pval_df[nrow(pval_df), ncol(pval_df)],3)
  sectoral_distance_logistic_graphs[[sector_of_interest]]<-allEffects(model_of_interest)
}


plot(sectoral_distance_logistic_graphs$sev_score.wash.total, main=paste0("WASH Sectoral Score (p =  ",pval$sev_score.wash.total,")"))
plot(sectoral_distance_logistic_graphs$sev_score.snfi.total,main=paste0("SNFI Sectoral Score (p =  ",pval$sev_score.snfi.total,")"))

plot(sectoral_distance_logistic_graphs$sev_score.health.total, main=paste0("Health Sectoral Score (p =  ",pval$sev_score.health.total,")"))
plot(sectoral_distance_logistic_graphs$sev_score.education.total,main=paste0("Education Sectoral Score (p =  ",pval$sev_score.education.total,")"))
plot(sectoral_distance_logistic_graphs$sev_score.protection.total,main=paste0("Protection Sectoral Score (p =  ",pval$sev_score.protection.total,")"))
plot(sectoral_distance_logistic_graphs$sev_score.FS.total,main=paste0("Food Security Sectoral Score (p =  ",pval$sev_score.FS.total,")"))

asdf<-coef(summary(model_of_interest  )) %>% data.frame()

asdf$Pr...t..
HH_srvy_ob$variables$sev_score



colnames(HH_srvy_ob$variables)

HH_svy_ob$variables$I.FLS.at_leastoneworking_binary = if_else(HH_svy_ob$variables$I.FSL.livelihoods_atleast_one.INDVHH=="yes",1,0,0)

HH_svy_ob$variables$I.HH_CHAR.dependency_ratio.INDVHH



m7<-svyglm(formula = I.FLS.at_leastoneworking_binary~ I.HH_CHAR.dependency_ratio.INDVHH,HH_svy_ob)

m7<-svyglm(formula = I.FLS.at_leastoneworking_binary~ I.HH_CHAR.dependency_ratio.INDVHH,HH_svy_ob, na.action=TRUE)
?svyglm

# dist to camp by camp ----------------------------------------------------

p8 <- ggplot(HH_data_factorized, aes(x = euc_dist_to_camp_m, fill = factor(!!sym(strata)))) +
  geom_density(position="identity", alpha=0.6) +
  # scale_x_continuous(name = "Mean ozone in\nparts per billion",
  # breaks = seq(0, 200, 25),
  # limits=c(0, 200)) +
  scale_y_continuous(name = "Density") +
  
  ggtitle("Dist to Camp") +
  theme_bw() +
  theme(plot.title = element_text(size = 14, family = "Tahoma", face = "bold"),
        text = element_text(size = 12, family = "Tahoma")) #+
# scale_fill_brewer(palette="Accent")

p8














independent_variables<- c("I.HH_CHAR.dependency_ratio_classification.HH", "I.HH_CHAR.size.HH", "I.HH_CHAR.gender_hoh.HH", "I.HH_CHAR.education_level.HH", "I.HEALTH.indhelp_atleast.INDVHH")


dependent_variables<-c("I.FSL.livelihoods_atleast_one.INDVHH", "I.coping.new_debt") %>% trimws()
# svyby(~I.FSL.livelihoods_atleast_one.INDVHH, ~I.HH_CHAR.dependency_ratio_classification.HH, svymean, HH_svy_ob )



HH_srvy_ob<-srvyr::as_survey(HH_svy_ob)
HH_srvy_ob$variable$I.FSL.livelihoods_atleast_one.INDVHH

HH_srvy_ob$variables$I.FSL.livelihoods_atleast_one.INDVHH %>% class(
  
  
)

HH_srvy_ob %>%
  group_by(I.HH_CHAR.dependency_ratio_classification.HH,I.FSL.livelihoods_atleast_one.INDVHH,.drop=FALSE) %>%
  summarise(mean.stat=survey_mean(na.rm=TRUE,vartype="ci" )) 


HH_srvy_ob %>% 
  group_by( I.FSL.livelihoods_atleast_one.INDVHH) %>% 
  summarise(survey_mean(na.rm=TRUE,vartype="ci"))


asdf<-survey::svyby(~I.FSL.livelihoods_atleast_one.INDVHH, ~I.HH_CHAR.dependency_ratio_classification.HH,HH_svy_ob, svymean,vartype="ci", na.rm=T) %>% data.frame() 
asdf<-survey::svychisq(~I.HH_CHAR.dependency_ratio_classification.HH+I.FSL.livelihoods_atleast_one.INDVHH,HH_svy_ob)
asdf$p.value

asdf<-survey:: (~I.FSL.livelihoods_atleast_one.INDVHH, ~I.HH_CHAR.dependency_ratio_classification.HH,HH_svy_ob, svymean,vartype="ci", na.rm=T) %>% data.frame() 


asdf

plot_list<-list()
svyby_table_list<-list()
significant_table_list<-list()
for ( i in 1:length(dependent_variables)){
  print(dependent_variables[i])
  independent_string<-"I.HH_CHAR.dependency_ratio_classification.HH"
  dependent_string<-dependent_variables[i]
  
  dependent_string.yesans<-paste0(dependent_string,"yes")
  se_dependent_string<-paste0("se.", dependent_string)
  formula_dependent<-paste0("~", dependent_string)
  formula_independent<-paste0("~",independent_string)
  table_formula<-(paste0(formula_independent, "+", dependent_string))
  print(table_formula)
  result_chisq<-svychisq(formula(table_formula),HH_svy_ob)
  print("chisq stat calculated")
  pval<-result_chisq$p.value
  pval_label<-ifelse(pval<0.05,"<.05", ifelse(pval<.005,"<.005",">.05"))
  print("pval label made")
  # plot_title<-paste0(plot_titles[i]," (p",pval_label,")")
  plot_title<-paste0(dependent_string," (p",pval_label,")")
  svyby_table<-svyby(formula(formula_dependent), formula(formula_independent),HH_svy_ob, svymean, na.rm=T) %>% data.frame() 
  print("svytable made")
  
  
  dependent_string.yes<-svyby_table %>%
    select(intersect(starts_with(dependent_string),
                     ends_with("yes"))) %>% colnames()
  print("asdf")
  se_dependent_string.yes<-svyby_table %>% 
    select(intersect(starts_with(se_dependent_string), 
                     ends_with("yes"))) %>% colnames()
  
  svyby_table<-svyby_table %>% 
    mutate(
      err_ymin=!!sym(dependent_string.yes)-(1.96*!!sym(se_dependent_string.yes)),
      err_ymax=!!sym(dependent_string.yes)+(1.96*!!sym(se_dependent_string.yes)),
    )
  print("asdfgh")
  er<-geom_errorbar(data = svyby_table,aes(ymin=err_ymin,
                                           ymax=err_ymax), color="white", size=2,width=0.2)
  plot_list[[dependent_string]]<-
    ggplot(svyby_table,aes(factor(!!sym(independent_string)), !!sym(dependent_string.yes)))+
    geom_bar(stat= "identity", colour="white")+
    er+
    xlab("I.indi_dia_per_INDIVHH")+ 
    ggtitle(plot_title)+
    scale_y_continuous(labels = scales::percent)+
    theme(
      panel.grid = element_blank(),
      axis.title.y = element_blank(),
      axis.text.y = element_text(angle=45,size = 10),
      # text = element_text(size=10)
    )
  
  svyby_table_list[[dependent_string]]<-svyby_table
  
  if(result_chisq$p.value<.05){
    significant_table_list[[dependent_string]]<-svyby_table
  }
  if(result_chisq$p.value>=0.05){
    not_significant_table_list[[dependent_string]]<-svyby_table
  }
}






